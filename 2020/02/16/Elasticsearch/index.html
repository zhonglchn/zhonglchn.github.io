<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Zhong L">





<title>Elasticsearch | 明天就放假了</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">ZhongL&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ZhongL&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Elasticsearch</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Zhong L</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">二月 16, 2020&nbsp;&nbsp;17:00:44</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/java/">java</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="01、ElasticSearch简介"><a href="#01、ElasticSearch简介" class="headerlink" title="01、ElasticSearch简介"></a>01、ElasticSearch简介</h2><h4 id="1-1-什么是ElasticSearch"><a href="#1-1-什么是ElasticSearch" class="headerlink" title="1.1 什么是ElasticSearch"></a>1.1 什么是ElasticSearch</h4><p>Elaticsearch，简称为es，es是一个开源的高扩展的分布式全文搜索服务，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。es也是使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。1PB=1024TB</p>
<h4 id="1-2-ElasticSearch使用案例"><a href="#1-2-ElasticSearch使用案例" class="headerlink" title="1.2 ElasticSearch使用案例"></a>1.2 ElasticSearch使用案例</h4><ul>
<li>2013年初，GitHub抛弃了Solr，采取ElasticSearch来做PB级的搜索。“GitHub使用ElasticSearch搜索20TB的数据，包括13亿文件和1300亿行代码”。</li>
<li>维基百科：启动以elasticsearch为基础的核心搜索架构。</li>
<li>SoundCloud：“SoundCloud使用ElasticSearch为1.8亿用户提供即时而精准的音乐搜索服务”。</li>
<li>百度：百度目前广泛使用ElasticSearch作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部20多个业务线（包括casio、云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大100台机器，200个ES节点，每天导入30TB+数据。</li>
<li>新浪使用ES 分析处理32亿条实时日志。</li>
<li>阿里使用ES  构建挖财自己的日志采集和分析体系。</li>
</ul>
<h4 id="1-3-ElasticSearch对比Solr"><a href="#1-3-ElasticSearch对比Solr" class="headerlink" title="1.3 ElasticSearch对比Solr"></a>1.3 ElasticSearch对比Solr</h4><ul>
<li>Solr利用 Zookeeper 进行分布式管理，而 Elasticsearch 自身带有分布式协调管理功能。</li>
<li>Solr支持更多格式的数据，而Elasticsearch仅支持json文件格式。</li>
<li>Solr官方提供的功能更多，而Elasticsearch本身更注重于核心功能，高级功能都有第三方插件提供。</li>
<li>Solr在传统的搜索应用中表现好于Elasticsearch，但在处理实时搜索应用时效率明显低于  Elasticsearch当单纯的对已有数据进行搜索时，Solr更快,当实时建立索引时, Solr会产生io阻塞，查询性能较差, Elasticsearch具有明显的优势。随着数据量的增加，Solr的搜索效率会变得更低，而Elasticsearch却没有明显的变化。综上所述，<strong>Solr的架构不适合实时搜索的应用</strong>。Solr是传统搜索应用的有力解决方案，但 <strong>Elasticsearch 更适用于新兴的实时搜索应用</strong>。</li>
</ul>
<h2 id="02、ElasticSearch：安装-amp-启动"><a href="#02、ElasticSearch：安装-amp-启动" class="headerlink" title="02、ElasticSearch：安装&amp;启动"></a>02、ElasticSearch：安装&amp;启动</h2><h4 id="2-1-下载"><a href="#2-1-下载" class="headerlink" title="2.1 下载"></a>2.1 下载</h4><ul>
<li><p>ElasticSearch分为Linux和Window版本，基于我们主要学习的是ElasticSearch的Java客户端的使用，所以我们课程中使用的是安装较为简便的Window版本，项目上线后，公司的运维人员会安装Linux版的ES供我们连接使用。</p>
</li>
<li><p>ElasticSearch官方地址：<a href="https://www.elastic.co/products/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/products/elasticsearch</a></p>
<p><img src="/2020/02/16/Elasticsearch/1573459143961.png" alt="01"></p>
<p><img src="/2020/02/16/Elasticsearch/1573459250193.png" alt="1573459250193"></p>
<p><img src="/2020/02/16/Elasticsearch/1573459372487.png" alt="03"></p>
<p><img src="/2020/02/16/Elasticsearch/1573459444499.png" alt="04"> </p>
<p>在“资料”中已经提供了下载好的elasticsearch-6.2.2.zip压缩包</p>
<p><img src="/2020/02/16/Elasticsearch/1573460192291.png" alt="05"> </p>
</li>
</ul>
<h4 id="2-2-安装"><a href="#2-2-安装" class="headerlink" title="2.2 安装"></a>2.2 安装</h4><p>Window版的ElasticSearch的安装很简单，类似Window版的Tomcat，解压开即安装完毕，解压后的ElasticSearch的目录结构如下:</p>
<p><img src="/2020/02/16/Elasticsearch/1573460207272.png" alt="1573460207272"> </p>
<h4 id="2-3-启动"><a href="#2-3-启动" class="headerlink" title="2.3 启动"></a>2.3 启动</h4><p>进入elasticsearch-6.6.2\bin目录，点击elasticsearch.bat启动:</p>
<p><img src="/2020/02/16/Elasticsearch/1572261981080.png" alt="1573460314105"> </p>
<p><img src="/2020/02/16/Elasticsearch/1573462020231.png" alt="1573462020231"> </p>
<p><img src="/2020/02/16/Elasticsearch/1573461655107.png" alt="1573461655107"> </p>
<p><strong>注意：启动时可能会出现JVM堆内存不够的错误。需修改elasticsearch-6.6.2/config目录下的配置文件jvm.options</strong></p>
<p><img src="/2020/02/16/Elasticsearch/1573460440883.png" alt="1573460440883"> </p>
<p>浏览器访问：<code>http://localhost:9200</code> 看到如下返回的json信息，代表ES服务启动成功:</p>
<p><img src="/2020/02/16/Elasticsearch/1573460766189.png" alt="1573460766189"> </p>
<blockquote>
<p><strong>注意：ElasticSearch是用java开发的，且本版本的es需要的jdk版本要是JDK1.8+，并配置好JDK环境变量，否则启动ElasticSearch失败。</strong> </p>
</blockquote>
<h2 id="03、ElasticSearch：管理应用部署"><a href="#03、ElasticSearch：管理应用部署" class="headerlink" title="03、ElasticSearch：管理应用部署"></a>03、ElasticSearch：管理应用部署</h2><p>ElasticSearch不同于Solr自带图形化界面，我们可以通过安装ElasticSearch的head插件，完成图形化界面的效果，完成索引数据的查看。在资料中已经提供了head插件压缩包。</p>
<ul>
<li><p>下载head插件：<code>https://github.com/mobz/elasticsearch-head</code></p>
<p><img src="/2020/02/16/Elasticsearch/1573462353305.png" alt="1573462353305"> </p>
</li>
<li><p>部署elasticsearch-head-master插件</p>
<ul>
<li><p>拷贝apache-tomcat-8.5.28.zip到D:\es目录下解压，更名为tomcat-head</p>
<p><img src="/2020/02/16/Elasticsearch/1573462523115.png" alt="1573462523115"> </p>
</li>
<li><p>删除tomcat-head\webapps目录下全部项目</p>
<p><img src="/2020/02/16/Elasticsearch/1573462635549.png" alt="1573462635549"> </p>
</li>
<li><p>拷贝“资料”目录下的elasticsearch-head-master.zip到D:\es\tomcat-head\webapps目录下，解压，更名为ROOT</p>
<p><img src="/2020/02/16/Elasticsearch/1573462711945.png" alt="1573462711945"> </p>
</li>
<li><p>启动tomcat，打开浏览器输入 <code>http://localhost:8080</code>，看到如下页面:</p>
<p><img src="/2020/02/16/Elasticsearch/1573463206657.png" alt="1573463206657"> </p>
</li>
<li><p>head管理应用默认连接不上ES服务端的，会报以下错误：</p>
<p><img src="/2020/02/16/Elasticsearch/1573463286436.png" alt="1573463286436"> </p>
<p>原因: Elasticsearch-head  跨域 访问ES服务端，产生跨域请求错误。</p>
</li>
</ul>
</li>
<li><p>配置ES服务端允许跨域访问</p>
<p>修改elasticsearch-6.6.2\config目录下的elasticsearch.yml，增加以下配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置跨域</span></span><br><span class="line"><span class="meta">http.cors.enabled</span>: <span class="string">true </span></span><br><span class="line"><span class="meta">http.cors.allow-origin</span>: <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/16/Elasticsearch/wps1.jpg" alt="img"> </p>
<p>重新启动ES服务，用Head插件连接ES服务，效果如下：</p>
<p><img src="/2020/02/16/Elasticsearch/wps2.jpg" alt="img"></p>
</li>
</ul>
<h2 id="04、ElasticSearch：核心概念"><a href="#04、ElasticSearch：核心概念" class="headerlink" title="04、ElasticSearch：核心概念"></a>04、ElasticSearch：核心概念</h2><blockquote>
<p>目标: 了解ElasticSearch的相关概念: 集群、节点、索引、类型、文档、分片、映射是什么？</p>
</blockquote>
<h4 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h4><p>Elasticsearch面向文档(document oriented)的，这意味着它可以存储整个对象或文档(document)。然而它不仅仅是存储，还会索引(index)每个文档的内容使之可以被搜索。在Elasticsearch中，你可以对文档进行索引、搜索、排序、过滤。</p>
<p>关系型数据库与ES索引库类比:</p>
<table>
<thead>
<tr>
<th>关系型数据库</th>
<th>数据库</th>
<th>表</th>
<th>行</th>
<th>列</th>
</tr>
</thead>
<tbody><tr>
<td>Relational DB</td>
<td>Databases</td>
<td>Tables</td>
<td>Rows</td>
<td>Columns</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ES服务</th>
<th>索引库</th>
<th>类型</th>
<th>文档</th>
<th>字段</th>
</tr>
</thead>
<tbody><tr>
<td>ElasticSearch</td>
<td>Indices</td>
<td>Types</td>
<td>Documents</td>
<td>Fields</td>
</tr>
</tbody></table>
<h4 id="4-2-核心概念"><a href="#4-2-核心概念" class="headerlink" title="4.2 核心概念"></a>4.2 核心概念</h4><p><img src="/2020/02/16/Elasticsearch/1551061589694.png" alt="1551061589694"> </p>
<ul>
<li><p><strong>近实时 NRT</strong>(Near Realtime)–速度快</p>
<p>Elasticsearch是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟（通常是1秒以内）</p>
</li>
<li><p><strong>集群 cluster</strong></p>
<p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。一个集群由一个唯一的名字标识，==这个名字默认就是“elasticsearch”。==这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。</p>
</li>
<li><p><strong>节点 node</strong></p>
<p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于Elasticsearch集群中的哪些节点。 一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此， 它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。 在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点， 这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。</p>
</li>
<li><p><strong>索引 index(重点)</strong>–索引库</p>
<ul>
<li>几分相似特征的文档的集合。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</li>
<li>一个索引就是一个拥有几分相似特征的文档的集合。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</li>
</ul>
</li>
<li><p><strong>类型 type(重点)</strong>–表</p>
<p>在一个索引中，你只能定义一种类型。一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定。通常，会为具有一组共同字段的文档定义一个类型。比如说，我们假设你运营一个博客平台并且将你所有的数据存储到一个索引中。在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可以为评论数据定义另一个类型。</p>
</li>
<li><p><strong>文档 document(重点)</strong>–json</p>
<p>一个文档是一个可被索引的基础信息单元。比如，你可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以JSON（Javascript Object Notation）格式来表示，而JSON是一个到处存在的互联网数据交互格式。 在一个index/type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在于一个索引之中，文档必须 被索引/赋予一个索引的type。</p>
</li>
<li><p><strong>分片和复制shards&amp;replicas</strong>–自我、修复、备份</p>
<p>一个索引可以存储超出单个节点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。分片很重要，主要有两方面的原因：</p>
<ul>
<li>允许你水平分割/扩展你的内容容量。</li>
<li>允许你在分片（潜在地，位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说，这些都是透明的。在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为搜索可以在所有的复制上并行运行。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。默认情况下，Elasticsearch中的每个索引被分片5个主分片和1个复制，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共就有10个分片。</li>
</ul>
</li>
<li><p><strong>映射 mapping(重点)</strong></p>
<p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分析器、是否被索引等等，这些都是映射里面可以设置的，其它就是处理es里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好？和建立表结构表关系数据库三范式类似。【是否分词、是否索引、是否存储】</p>
</li>
</ul>
<h4 id="4-3-小结"><a href="#4-3-小结" class="headerlink" title="4.3 小结"></a>4.3 小结</h4><ul>
<li><p>什么是集群</p>
</li>
<li><blockquote>
<p>给所有的es节点，定义一个相同的名字: 默认名字是elasticsearch,就可以自动转换成集群。</p>
</blockquote>
</li>
<li><p>什么是节点</p>
<blockquote>
<p>每一个es服务就是一个节点。只要节点名字不相同，就可以形成一个集群。</p>
</blockquote>
</li>
<li><p>什么是索引(Indices)（重点）</p>
<blockquote>
<p>一个索引就是一个拥有相似特征的文档的集合,（足够灵活。数据结构可以不一样）。</p>
</blockquote>
</li>
<li><p>什么是类型(Types)（重点）</p>
<blockquote>
<p>类型数据的表，进行文档的区分。</p>
</blockquote>
</li>
<li><p>什么是文档(Document)（重点）</p>
<blockquote>
<p>数据存储的结构，数据结构：json</p>
</blockquote>
</li>
<li><p>什么是映射(Mapping)</p>
<blockquote>
<p>是定义文档数据结构的属性的规范。比如属性：是否要存储，是否要索引，采用什么样的分词等。</p>
</blockquote>
</li>
</ul>
<h2 id="05、ElasticSearch：搭建测试环境"><a href="#05、ElasticSearch：搭建测试环境" class="headerlink" title="05、ElasticSearch：搭建测试环境"></a>05、ElasticSearch：搭建测试环境</h2><h4 id="5-1-创建测试模块"><a href="#5-1-创建测试模块" class="headerlink" title="5.1 创建测试模块"></a>5.1 创建测试模块</h4><p><img src="/2020/02/16/Elasticsearch/1573466182754.png" alt="1573466182754"></p>
<h4 id="5-2-配置依赖"><a href="#5-2-配置依赖" class="headerlink" title="5.2 配置依赖"></a>5.2 配置依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-3-提供log4j2-xml"><a href="#5-3-提供log4j2-xml" class="headerlink" title="5.3 提供log4j2.xml"></a>5.3 提供log4j2.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="06、ElasticSearch：创建索引库"><a href="#06、ElasticSearch：创建索引库" class="headerlink" title="06、ElasticSearch：创建索引库"></a>06、ElasticSearch：创建索引库</h2><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><blockquote>
<p>掌握创建索引库的代码实现</p>
</blockquote>
<h4 id="编程步骤"><a href="#编程步骤" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>使用传输客户端对象创建索引库</li>
<li>释放资源</li>
</ul>
<h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 创建索引库 */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 1. 创建Settings配置信息对象(主要配置集群名称)</span></span><br><span class="line">        <span class="comment">// 参数一: 集群key (固定不变)</span></span><br><span class="line">        <span class="comment">// 参数二：集群环境名称,默认的ES的环境集群名称为 "elasticsearch"</span></span><br><span class="line">        Settings settings = Settings.builder()</span><br><span class="line">                .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">        TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">        <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">        <span class="comment">// 参数一：主机</span></span><br><span class="line">        <span class="comment">// 参数二：端口</span></span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">                InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建索引库(index)</span></span><br><span class="line">        <span class="comment">// 获取索引库管理客户端执行创建索引库，并执行请求</span></span><br><span class="line">        transportClient.admin().indices().prepareCreate(<span class="string">"blog1"</span>).get();</span><br><span class="line">        <span class="comment">// 4. 释放资源</span></span><br><span class="line">        transportClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2020/02/16/Elasticsearch/1573482309057.png" alt="1573482309057">   </p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><blockquote>
<p>创建索引库核心代码:</p>
<p><strong>transportClient.admin().indices().prepareCreate(“book”).get();</strong></p>
</blockquote>
<h2 id="07、ElasticSearch：添加文档"><a href="#07、ElasticSearch：添加文档" class="headerlink" title="07、ElasticSearch：添加文档"></a>07、ElasticSearch：添加文档</h2><blockquote>
<p>目标: 掌握 文档增加 的代码实现</p>
</blockquote>
<h4 id="7-1-第一种方式"><a href="#7-1-第一种方式" class="headerlink" title="7.1 第一种方式"></a>7.1 第一种方式</h4><p><strong>编程步骤</strong></p>
<ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建文档对象，创建一个json格式的字符串，或者使用XContentBuilder</li>
<li>传输客户端对象把文档添加到索引库中</li>
<li>释放资源</li>
</ul>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 添加文档: 第一种方式(XContentBuilder) */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">         TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建内容构建对象</span></span><br><span class="line">    XContentBuilder builder = XContentFactory.jsonBuilder()</span><br><span class="line">        .startObject()</span><br><span class="line">        .field(<span class="string">"id"</span>, <span class="number">1</span>)</span><br><span class="line">        .field(<span class="string">"title"</span>, <span class="string">"elasticsearch搜索服务"</span>)</span><br><span class="line">        .field(<span class="string">"content"</span>,<span class="string">"ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎。"</span>)</span><br><span class="line">        .endObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行索引库、类型、文档</span></span><br><span class="line">    transportClient.prepareIndex(<span class="string">"blog1"</span>,<span class="string">"article"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .setSource(builder).get(); <span class="comment">// 执行请求</span></span><br><span class="line">    <span class="comment">// 5. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-第二种方式"><a href="#7-2-第二种方式" class="headerlink" title="7.2 第二种方式"></a>7.2 第二种方式</h4><p><strong>编程步骤</strong></p>
<ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建Map集合，封装文档数据</li>
<li>传输客户端对象把文档添加到索引库中</li>
<li>释放资源</li>
</ul>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 创建文档: 第二种方式(使用Map集合) */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 定义Map集合封装文档</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    map.put(<span class="string">"id"</span>, <span class="number">2</span>);</span><br><span class="line">    map.put(<span class="string">"title"</span>, <span class="string">"dubbo分布式服务框架"</span>);</span><br><span class="line">    map.put(<span class="string">"content"</span>, <span class="string">"dubbo阿里巴巴开源的高性能的RPC框架。"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 添加文档</span></span><br><span class="line">    transportClient.prepareIndex(<span class="string">"blog1"</span>,<span class="string">"article"</span>, <span class="string">"2"</span>)</span><br><span class="line">        .setSource(map).get();</span><br><span class="line">    <span class="comment">// 5. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-第三种方式"><a href="#7-3-第三种方式" class="headerlink" title="7.3 第三种方式"></a>7.3 第三种方式</h4><p><strong>准备工作</strong></p>
<ul>
<li><p>引入jackson依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义pojo实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> title;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>编程步骤</strong></p>
<ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建pojo对象，封装文档数据</li>
<li>把实体对象转化成json字符串</li>
<li>传输客户端对象把文档添加到索引库中</li>
<li>释放资源</li>
</ul>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 创建文档: 第三种方式(使用POJO) */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建实体对象</span></span><br><span class="line">    Article article = <span class="keyword">new</span> Article();</span><br><span class="line">    article.setId(<span class="number">3</span>);</span><br><span class="line">    article.setTitle(<span class="string">"lucene全文检索框架"</span>);</span><br><span class="line">    article.setContent(<span class="string">"lucene是apache组织开源的全文检索框架。"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 把article转化成json字符串</span></span><br><span class="line">    String jsonStr = <span class="keyword">new</span> ObjectMapper().writeValueAsString(article);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 添加文档</span></span><br><span class="line">    transportClient.prepareIndex(<span class="string">"blog1"</span>,<span class="string">"article"</span>, <span class="string">"3"</span>)</span><br><span class="line">        .setSource(jsonStr, XContentType.JSON).get();</span><br><span class="line">    <span class="comment">// 6. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-4-小结"><a href="#7-4-小结" class="headerlink" title="7.4 小结"></a>7.4 小结</h4><ul>
<li>第一种方式: XContentBuilder封装文档数据</li>
<li>第二种方式: Map集合封装文档数据</li>
<li>第三种方式: pojo实体类封装文档数据</li>
</ul>
<h2 id="08、ElasticSearch：批量添加文档"><a href="#08、ElasticSearch：批量添加文档" class="headerlink" title="08、ElasticSearch：批量添加文档"></a>08、ElasticSearch：批量添加文档</h2><blockquote>
<p>目标: 掌握文档批量增加的代码实现</p>
</blockquote>
<h4 id="编程步骤-1"><a href="#编程步骤-1" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建批量请求构建对象</li>
<li>批量请求构建对象 循环添加 索引请求对象</li>
<li>批量请求构建对象提交请求</li>
<li>释放资源</li>
</ul>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 批量添加文档 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line">    <span class="comment">// 3. 创建批量请求构建对象</span></span><br><span class="line">    BulkRequestBuilder bulkRequestBuilder = transportClient.prepareBulk();</span><br><span class="line">    <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 4. 循环创建文档，添加索引请求对象</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i++)&#123;</span><br><span class="line">        Article article = <span class="keyword">new</span> Article();</span><br><span class="line">        article.setId(i);</span><br><span class="line">        article.setTitle(<span class="string">"dubbo分布式服务框架"</span> + i);</span><br><span class="line">        article.setContent(<span class="string">"dubbo阿里巴巴开源的高性能的RPC框架"</span> + i);</span><br><span class="line">        <span class="comment">// 4.1 创建索引请求对象</span></span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"blog1"</span>,<span class="string">"article"</span>, i + <span class="string">""</span>)</span><br><span class="line">            .source(<span class="keyword">new</span> ObjectMapper().writeValueAsString(article),</span><br><span class="line">                    XContentType.JSON);</span><br><span class="line">        <span class="comment">// 4.2 添加索引请求对象</span></span><br><span class="line">        bulkRequestBuilder.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5. 提交请求</span></span><br><span class="line">    bulkRequestBuilder.get();</span><br><span class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"毫秒数："</span> + (end - begin));</span><br><span class="line">    <span class="comment">// 6. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="09、ElasticSearch：修改文档"><a href="#09、ElasticSearch：修改文档" class="headerlink" title="09、ElasticSearch：修改文档"></a>09、ElasticSearch：修改文档</h2><blockquote>
<p>目标: 掌握文档修改的代码实现</p>
</blockquote>
<h4 id="编程步骤-2"><a href="#编程步骤-2" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建pojo对象，封装文档数据</li>
<li>把实体对象转化成json字符串</li>
<li>传输客户端对象修改文档到索引库</li>
<li>释放资源</li>
</ul>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 修改文档 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建实体对象</span></span><br><span class="line">    Article article = <span class="keyword">new</span> Article();</span><br><span class="line">    article.setId(<span class="number">1</span>);</span><br><span class="line">    article.setTitle(<span class="string">"lucene全文检索框架"</span>);</span><br><span class="line">    article.setContent(<span class="string">"lucene是apache组织开源的全文检索框架。"</span>);</span><br><span class="line">    <span class="comment">// 4. 把article转化成json字符串</span></span><br><span class="line">    String jsonStr = <span class="keyword">new</span> ObjectMapper().writeValueAsString(article);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 修改文档</span></span><br><span class="line">    transportClient.prepareUpdate(<span class="string">"blog1"</span>,<span class="string">"article"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .setDoc(jsonStr, XContentType.JSON).get();</span><br><span class="line">    <span class="comment">// 6. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意: 修改的时候，如果不存在这个id，会报错(id改成了10000)</p>
<p><img src="/2020/02/16/Elasticsearch/1573487830588.png" alt="1573487830588">   </p>
<h2 id="10、ElasticSearch：删除文档"><a href="#10、ElasticSearch：删除文档" class="headerlink" title="10、ElasticSearch：删除文档"></a>10、ElasticSearch：删除文档</h2><blockquote>
<p>目标: 掌握文档删除的代码实现</p>
</blockquote>
<h4 id="编程步骤-3"><a href="#编程步骤-3" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>传输客户端对象删除文档</li>
<li>释放资源</li>
</ul>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 删除文档 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 删除文档</span></span><br><span class="line">    transportClient.prepareDelete(<span class="string">"blog1"</span>, <span class="string">"article"</span>, <span class="string">"1"</span>).get();</span><br><span class="line">    <span class="comment">// 4. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11、ElasticSearch：删除索引库"><a href="#11、ElasticSearch：删除索引库" class="headerlink" title="11、ElasticSearch：删除索引库"></a>11、ElasticSearch：删除索引库</h2><blockquote>
<p>目标: 掌握删除索引库的实现</p>
</blockquote>
<h4 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h4><p><img src="/2020/02/16/Elasticsearch/1573488203069.png" alt="1573488203069"> </p>
<h4 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h4><ul>
<li><p>操作步骤</p>
<ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>索引库管理客户端删除索引库</li>
<li>释放资源</li>
</ul>
</li>
<li><p>代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 删除索引库 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test8</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 删除索引库</span></span><br><span class="line">    transportClient.admin().indices().prepareDelete(<span class="string">"blog1"</span>).get();</span><br><span class="line">    <span class="comment">// 4. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="12、ElasticSearch：IK中文分词器"><a href="#12、ElasticSearch：IK中文分词器" class="headerlink" title="12、ElasticSearch：IK中文分词器"></a>12、ElasticSearch：IK中文分词器</h2><blockquote>
<p>目标: 熟悉 ElasticSearch IK分词器集成</p>
</blockquote>
<p>ElasticSearch的<strong>默认分词器是单字分词器</strong>，当我们创建索引时，没有特定的进行映射的创建，所以会使用默认的分词器进行分词，即每个字单独分成一个词。 例如：我是程序员 分词后的效果为：我、是、程、序、员 而我们需要的分词效果是：我、是、程序、程序员 这样的话就需要对中文支持良好的分词器，支持中文分词的分词器有很多，word分词器、庖丁解牛、盘古分词、Ansj分词等，但我们常用的还是下面要介绍的<strong>IK分词器</strong>。</p>
<p><img src="/2020/02/16/Elasticsearch/1573521971232.png" alt="1573521971232"> </p>
<h4 id="12-1-IK分词器介绍"><a href="#12-1-IK分词器介绍" class="headerlink" title="12.1 IK分词器介绍"></a>12.1 IK分词器介绍</h4><ul>
<li>IKAnalyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包。从2006年12月推出1.0版开始，IKAnalyzer已经推出 了3个大版本。最初，它是以开源项目Lucene为应用主体的，结合词典分词和文法分析算法的中文分词组件。新版本的IKAnalyzer3.0则发展为 面向Java的公用分词组件，独立于Lucene项目，同时提供了对Lucene的默认优化实现。</li>
<li>IK分词器3.0的特性如下:<ul>
<li>采用了特有的“正向迭代最细粒度切分算法“，具有60万字/秒的高速处理能力。</li>
<li>采用了多子处理器分析模式，支持：英文字母（IP地址、Email、URL）、数字（日期，常用中文数量词，罗马数字，科学计数法），中文词汇（姓名、地名处理）等分词处理。</li>
<li>对中英联合支持不是很好,在这方面的处理比较麻烦.需再做一次查询,同时是支持个人词条的优化的词典存储，更小的内存占用。</li>
<li>支持用户词典扩展定义。</li>
<li>针对Lucene全文检索优化的查询分析器IKQueryParser；采用歧义分析算法优化查询关键字的搜索排列组合，能极大的提高Lucene检索的命中率。</li>
</ul>
</li>
</ul>
<h4 id="12-2-IK分词器集成"><a href="#12-2-IK分词器集成" class="headerlink" title="12.2 IK分词器集成"></a>12.2 IK分词器集成</h4><ul>
<li><p>第一步: 下载地址：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik/releases</a> 课程资料也提供了IK分词器的压缩包：</p>
<p><img src="/2020/02/16/Elasticsearch/1573522114892.png" alt="1573522114892"> </p>
</li>
<li><p>第二步: 解压，将解压后的elasticsearch文件夹拷贝到elasticsearch-6.6.2\plugins下，并重命名文件夹为ik</p>
<p><img src="/2020/02/16/Elasticsearch/1573522345001.png" alt="1573522345001"> </p>
</li>
<li><p>第三步: 重新启动ES服务器，即可加载IK分词器</p>
<p><img src="/2020/02/16/Elasticsearch/1573522383705.png" alt="1573522383705">  </p>
</li>
</ul>
<h4 id="12-3-IK分词器测试"><a href="#12-3-IK分词器测试" class="headerlink" title="12.3 IK分词器测试"></a>12.3 IK分词器测试</h4><ul>
<li><p>IK提供了两个分词算法<strong>ik_smart</strong> 和 <strong>ik_max_word</strong> 其中 ik_smart 为最少切分，ik_max_word为最细粒度切分。</p>
<ul>
<li><p>最小切分</p>
<p>请求地址：<a href="http://127.0.0.1:9200/_analyze?analyzer=ik_smart" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze</a></p>
<p>请求参数：{“analyzer” : “<strong>ik_smart</strong>“, “text” : “中国程序员”}</p>
<p><img src="/2020/02/16/Elasticsearch/1573522583719.png" alt="1573522583719"> </p>
</li>
<li><p>最细粒度切分</p>
<p>请求地址：<a href="http://127.0.0.1:9200/_analyze?analyzer=ik_smart" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze</a></p>
<p>请求参数：{“analyzer” : “<strong>ik_max_word</strong>“, “text” : “中国程序员”}</p>
<p><img src="/2020/02/16/Elasticsearch/1573522603197.png" alt="1573522603197"> </p>
</li>
</ul>
</li>
</ul>
<h2 id="13、ElasticSearch：创建映射"><a href="#13、ElasticSearch：创建映射" class="headerlink" title="13、ElasticSearch：创建映射"></a>13、ElasticSearch：创建映射</h2><blockquote>
<p>目标: 掌握 创建映射 的代码实现</p>
</blockquote>
<p>Mapping就是定义Document中的每个Field的特征（数据类型，是否存储，是否索引，是否分词等）</p>
<ul>
<li>类型名称: 就是前面讲的type的概念，类似于数据库中的表。</li>
<li>字段名: 任意填写，可以指定许多属性，例如<ul>
<li>type：类型，可以是text、long、short、date、integer、object等</li>
<li>index：是否索引，默认为true</li>
<li>store：是否存储，默认为false</li>
<li>analyzer：分词器，这里的ik_max_word即使用ik分词器</li>
</ul>
</li>
</ul>
<h4 id="编程步骤-4"><a href="#编程步骤-4" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>创建索引库管理客户端，创建空的索引库</li>
<li>创建映射信息json格式字符串，使用XContentBuilder</li>
<li>创建映射请求对象，封装请求信息</li>
<li>索引库管理客户端，为索引库添加映射</li>
<li>释放资源</li>
</ul>
<h4 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 创建索引库映射 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test9</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>, <span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>),<span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建索引库管理客户端</span></span><br><span class="line">    IndicesAdminClient indices = transportClient.admin().indices();</span><br><span class="line">    <span class="comment">// 3.1 创建空的索引库</span></span><br><span class="line">    indices.prepareCreate(<span class="string">"blog2"</span>).get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 创建映射信息json格式字符串，使用XContentBuilder</span></span><br><span class="line">    XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">    builder.startObject()</span><br><span class="line">        .startObject(<span class="string">"article"</span>)</span><br><span class="line">        .startObject(<span class="string">"properties"</span>);</span><br><span class="line"></span><br><span class="line">    builder.startObject(<span class="string">"id"</span>)</span><br><span class="line">        .field(<span class="string">"type"</span>, <span class="string">"long"</span>)</span><br><span class="line">        .field(<span class="string">"store"</span>, <span class="keyword">true</span>)</span><br><span class="line">        .endObject();</span><br><span class="line"></span><br><span class="line">    builder.startObject(<span class="string">"title"</span>)</span><br><span class="line">        .field(<span class="string">"type"</span>, <span class="string">"text"</span>)</span><br><span class="line">        .field(<span class="string">"store"</span>, <span class="keyword">true</span>)</span><br><span class="line">        .field(<span class="string">"analyzer"</span>, <span class="string">"ik_smart"</span>)</span><br><span class="line">        .endObject();</span><br><span class="line"></span><br><span class="line">    builder.startObject(<span class="string">"content"</span>)</span><br><span class="line">        .field(<span class="string">"type"</span>, <span class="string">"text"</span>)</span><br><span class="line">        .field(<span class="string">"store"</span>, <span class="keyword">true</span>)</span><br><span class="line">        .field(<span class="string">"analyzer"</span>,<span class="string">"ik_smart"</span>)</span><br><span class="line">        .endObject();</span><br><span class="line"></span><br><span class="line">    builder.endObject();</span><br><span class="line">    builder.endObject();</span><br><span class="line">    builder.endObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 创建映射请求对象，封装请求信息</span></span><br><span class="line">    PutMappingRequest mappingRequest = <span class="keyword">new</span> PutMappingRequest(<span class="string">"blog2"</span>)</span><br><span class="line">        .type(<span class="string">"article"</span>).source(builder);</span><br><span class="line">    <span class="comment">// 6. 索引库管理客户端，为索引库添加映射</span></span><br><span class="line">    indices.putMapping(mappingRequest).get();</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/16/Elasticsearch/1573525882047.png" alt="1573525882047">  </p>
<p><img src="/2020/02/16/Elasticsearch/1573523917877.png" alt="1573523917877"> </p>
<p><strong>小结</strong></p>
<ul>
<li>映射不可以覆盖, 一定是建完索引库马上去做。</li>
<li>创建映射，如果索引库不存在的会报错。因为它没有自动创建索引库的功能。</li>
</ul>
<h2 id="14、ElasticSearch查询：匹配全部查询"><a href="#14、ElasticSearch查询：匹配全部查询" class="headerlink" title="14、ElasticSearch查询：匹配全部查询"></a>14、ElasticSearch查询：匹配全部查询</h2><blockquote>
<p>目标: 掌握 匹配全部查询 的代码实现</p>
</blockquote>
<p>先运行以前添加文档的三个测试方法(修改索引库名称为blog2)。</p>
<p><img src="/2020/02/16/Elasticsearch/1573526457688.png" alt="1573526457688">  </p>
<h4 id="编程步骤-5"><a href="#编程步骤-5" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(匹配全部)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.matchAllQuery());</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequestBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 匹配全部 */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">        Settings settings = Settings.builder()</span><br><span class="line">                .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">        <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">        TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(Settings.EMPTY);</span><br><span class="line">        <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">                InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">        SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">                .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">        <span class="comment">// 3.1 设置查询条件 (匹配全部)</span></span><br><span class="line">        searchRequestBuilder.setQuery(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">        SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">            System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">            System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 7. 释放资源</span></span><br><span class="line">        transportClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573526308208.png" alt="1573526308208"> </p>
<h2 id="15、ElasticSearch查询：字符串查询"><a href="#15、ElasticSearch查询：字符串查询" class="headerlink" title="15、ElasticSearch查询：字符串查询"></a>15、ElasticSearch查询：字符串查询</h2><blockquote>
<p>目标: 掌握 字符串查询 的代码实现</p>
</blockquote>
<h4 id="编程步骤-6"><a href="#编程步骤-6" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(字符串查询)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.queryStringQuery(<span class="string">"搜索服务"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 字符串查询 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(Settings.EMPTY);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件(字符串查询)</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.queryStringQuery(<span class="string">"搜索服务"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">        System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">        System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">        System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573526909527.png" alt="1573526909527"> </p>
<h2 id="16、ElasticSearch查询：词条查询"><a href="#16、ElasticSearch查询：词条查询" class="headerlink" title="16、ElasticSearch查询：词条查询"></a>16、ElasticSearch查询：词条查询</h2><blockquote>
<p>目标: 掌握 词条查询 的代码实现</p>
</blockquote>
<h4 id="编程步骤-7"><a href="#编程步骤-7" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(词条查询)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.termQuery(<span class="string">"title"</span>,<span class="string">"搜索服务"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-6"><a href="#代码实现-6" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 词条查询(搜索条件不分词) */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(Settings.EMPTY);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件(词条查询)</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.termQuery(<span class="string">"title"</span>,<span class="string">"搜索服务"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">        System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">        System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">        System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573527275140.png" alt="1573527275140"> </p>
<blockquote>
<p>注意: 搜索条件不分词。</p>
</blockquote>
<h2 id="17、ElasticSearch查询：根据ID查询"><a href="#17、ElasticSearch查询：根据ID查询" class="headerlink" title="17、ElasticSearch查询：根据ID查询"></a>17、ElasticSearch查询：根据ID查询</h2><blockquote>
<p>目标: 掌握 根据多个id主键查询 的代码实现</p>
</blockquote>
<h4 id="编程步骤-8"><a href="#编程步骤-8" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(多个主键id)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.idsQuery().addIds(<span class="string">"2"</span>,<span class="string">"3"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-7"><a href="#代码实现-7" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 根据id主键查询*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(Settings.EMPTY);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件(多个主键id)</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.idsQuery().addIds(<span class="string">"2"</span>,<span class="string">"3"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">        System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">        System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">        System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573528234404.png" alt="1573528234404"> </p>
<h2 id="18、ElasticSearch查询：范围查询"><a href="#18、ElasticSearch查询：范围查询" class="headerlink" title="18、ElasticSearch查询：范围查询"></a>18、ElasticSearch查询：范围查询</h2><blockquote>
<p>目标: 掌握 范围查询 的代码实现</p>
</blockquote>
<h4 id="编程步骤-9"><a href="#编程步骤-9" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(范围查询)</span></span><br><span class="line"><span class="comment">// from("1", false): 开始(是否包含开始)</span></span><br><span class="line"><span class="comment">// to("3", false): 结束(是否包含结束)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.rangeQuery(<span class="string">"id"</span>)</span><br><span class="line">                              .from(<span class="string">"1"</span>, <span class="keyword">false</span>)</span><br><span class="line">                              .to(<span class="string">"3"</span>, <span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-8"><a href="#代码实现-8" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 范围查询 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(Settings.EMPTY);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件(范围查询)</span></span><br><span class="line">    <span class="comment">// from("1", false): 开始(是否包含开始)</span></span><br><span class="line">    <span class="comment">// to("3", false): 结束(是否包含结束)</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.rangeQuery(<span class="string">"id"</span>)</span><br><span class="line">                                  .from(<span class="string">"1"</span>, <span class="keyword">false</span>).to(<span class="string">"3"</span>, <span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">        System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">        System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">        System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573528844880.png" alt="1573528844880"> </p>
<h2 id="19、ElasticSearch查询：分页和排序"><a href="#19、ElasticSearch查询：分页和排序" class="headerlink" title="19、ElasticSearch查询：分页和排序"></a>19、ElasticSearch查询：分页和排序</h2><blockquote>
<p>目标: 掌握 分页排序查询 的代码实现</p>
</blockquote>
<h4 id="编程步骤-10"><a href="#编程步骤-10" class="headerlink" title="编程步骤"></a>编程步骤</h4><ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件、分页、排序)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件(匹配查询)</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.matchQuery(<span class="string">"title"</span>,<span class="string">"服务框架"</span>));</span><br><span class="line"><span class="comment">// 设置分页起始数 (当前页码 - 1) * 页大小</span></span><br><span class="line">searchRequestBuilder.setFrom(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 设置页大小</span></span><br><span class="line">searchRequestBuilder.setSize(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 设置根据id排序(升序)</span></span><br><span class="line">searchRequestBuilder.addSort(<span class="string">"id"</span>, SortOrder.ASC);</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果</p>
</li>
<li><p>释放资源</p>
</li>
</ul>
<h4 id="代码实现-9"><a href="#代码实现-9" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 搜索分页、排序 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件(匹配查询)</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.matchQuery(<span class="string">"title"</span>,<span class="string">"服务框架"</span>));</span><br><span class="line">    <span class="comment">// 3.2 设置分页起始数 (当前页码 - 1) * 页大小</span></span><br><span class="line">    searchRequestBuilder.setFrom(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 3.3 设置页大小</span></span><br><span class="line">    searchRequestBuilder.setSize(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 3.4 设置根据id排序(升序)</span></span><br><span class="line">    searchRequestBuilder.addSort(<span class="string">"id"</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573529973243.png" alt="1573529973243"> </p>
<h2 id="20、ElasticSearch查询：高亮显示"><a href="#20、ElasticSearch查询：高亮显示" class="headerlink" title="20、ElasticSearch查询：高亮显示"></a>20、ElasticSearch查询：高亮显示</h2><blockquote>
<p>目标: 掌握 文档高亮显示 的代码实现</p>
</blockquote>
<h4 id="20-1-什么是高亮显示"><a href="#20-1-什么是高亮显示" class="headerlink" title="20.1 什么是高亮显示"></a>20.1 什么是高亮显示</h4><ul>
<li><p>根据关键字搜索时，搜索出的内容中的关键字会显示不同的颜色，称之为高亮百度搜索关键字”elasticsearch”</p>
<p><img src="/2020/02/16/Elasticsearch/1573531763857.png" alt="1573531763857"> </p>
</li>
<li><p>京东商城搜索“iphone xs max”</p>
<p><img src="/2020/02/16/Elasticsearch/1573531786291.png" alt="1573531786291"> </p>
</li>
</ul>
<h4 id="20-2-高亮显示html分析"><a href="#20-2-高亮显示html分析" class="headerlink" title="20.2 高亮显示html分析"></a>20.2 高亮显示html分析</h4><ul>
<li><p>通过开发者工具查看高亮数据的html代码实现:</p>
<p><img src="/2020/02/16/Elasticsearch/1573531831288.png" alt="1573531831288"> </p>
<p>说明: ElasticSearch可以对查询出的内容中关键字部分进行标签和样式的设置，但是你需要告诉ElasticSearch使用什么标签对高亮关键字进行包裹。</p>
</li>
</ul>
<h4 id="20-3-高亮显示实现"><a href="#20-3-高亮显示实现" class="headerlink" title="20.3 高亮显示实现"></a>20.3 高亮显示实现</h4><p><strong>编程步骤</strong></p>
<ul>
<li><p>创建Settings配置信息对象</p>
</li>
<li><p>创建ES传输客户端对象</p>
</li>
<li><p>创建搜索请求构建对象(封装查询条件、设置高亮对象)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置查询条件</span></span><br><span class="line">searchRequestBuilder.setQuery(QueryBuilders.termQuery(<span class="string">"content"</span>,<span class="string">"开源"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建高亮构建对象</span></span><br><span class="line">HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line"><span class="comment">// 设置高亮字段</span></span><br><span class="line">highlightBuilder.field(<span class="string">"content"</span>);</span><br><span class="line"><span class="comment">// 设置高亮格式器前缀</span></span><br><span class="line">highlightBuilder.preTags(<span class="string">"&lt;font color='red'&gt;"</span>);</span><br><span class="line"><span class="comment">// 设置高亮格式器后缀</span></span><br><span class="line">highlightBuilder.postTags(<span class="string">"&lt;/font&gt;"</span>);</span><br><span class="line"><span class="comment">// 设置高亮对象</span></span><br><span class="line">searchRequestBuilder.highlighter(highlightBuilder);</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行请求,得到搜索响应对象</p>
</li>
<li><p>获取搜索结果</p>
</li>
<li><p>迭代搜索结果(获取高亮内容)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取高亮字段集合</span></span><br><span class="line">Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line"><span class="comment">// 获取content字段的高亮内容</span></span><br><span class="line">String content = highlightFields.get(<span class="string">"content"</span>).getFragments()[<span class="number">0</span>].toString();</span><br></pre></td></tr></table></figure>
</li>
<li><p>释放资源</p>
</li>
</ul>
<p><strong>代码实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 高亮显示 */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建Settings配置信息对象</span></span><br><span class="line">    Settings settings = Settings.builder()</span><br><span class="line">        .put(<span class="string">"cluster.name"</span>,<span class="string">"elasticsearch"</span>).build();</span><br><span class="line">    <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">    TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">    <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">    transportClient.addTransportAddress(<span class="keyword">new</span> TransportAddress(</span><br><span class="line">        InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9300</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">        .prepareSearch(<span class="string">"blog2"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">    <span class="comment">// 3.1 设置查询条件</span></span><br><span class="line">    searchRequestBuilder.setQuery(QueryBuilders.termQuery(<span class="string">"content"</span>,<span class="string">"开源"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2 创建高亮构建对象</span></span><br><span class="line">    HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">    <span class="comment">// 3.2.1 设置高亮字段</span></span><br><span class="line">    highlightBuilder.field(<span class="string">"content"</span>);</span><br><span class="line">    <span class="comment">// 3.2.2 设置高亮格式器前缀</span></span><br><span class="line">    highlightBuilder.preTags(<span class="string">"&lt;font color='red'&gt;"</span>);</span><br><span class="line">    <span class="comment">// 3.2.3 设置高亮格式器后缀</span></span><br><span class="line">    highlightBuilder.postTags(<span class="string">"&lt;/font&gt;"</span>);</span><br><span class="line">    <span class="comment">// 3.3 设置高亮对象</span></span><br><span class="line">    searchRequestBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">// 获取高亮字段集合</span></span><br><span class="line">        Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">        <span class="comment">// 获取content字段的高亮内容</span></span><br><span class="line">        String content = highlightFields.get(<span class="string">"content"</span>)</span><br><span class="line">                              .getFragments()[<span class="number">0</span>].toString();</span><br><span class="line">        System.out.println(hit.getSourceAsMap().get(<span class="string">"id"</span>) + <span class="string">"\t"</span></span><br><span class="line">                           + hit.getSourceAsMap().get(<span class="string">"title"</span>) + <span class="string">"\t"</span> + content);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 释放资源</span></span><br><span class="line">    transportClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><img src="/2020/02/16/Elasticsearch/1573532677574.png" alt="1573532677574"> </p>
<h2 id="21、课程总结"><a href="#21、课程总结" class="headerlink" title="21、课程总结"></a>21、课程总结</h2><p> <strong>今天课程重点</strong></p>
<ul>
<li><p>Elasticsearch安装与启动</p>
</li>
<li><p>Elasticsearch创建索引库</p>
</li>
<li><p>Elasticsearch添加文档</p>
</li>
<li><p>Elasticsearch修改文档</p>
</li>
<li><p>Elasticsearch删除文档</p>
</li>
<li><p>Elasticsearch创建映射</p>
</li>
<li><p>Elasticsearch查询</p>
<p><img src="/2020/02/16/Elasticsearch/1573543487274.png" alt="1573543487274"> </p>
</li>
</ul>
<h2 id="拓展：ElasticSearch集群搭建"><a href="#拓展：ElasticSearch集群搭建" class="headerlink" title="== 拓展：ElasticSearch集群搭建 =="></a>== 拓展：ElasticSearch集群搭建 ==</h2><h3 id="集群介绍"><a href="#集群介绍" class="headerlink" title="集群介绍"></a>集群介绍</h3><ul>
<li>ES集群是一个P2P类型（使用gossip协议）的分布式系统，除了集群状态管理以外，其他所有的请求都可以发送到集群内任意一台节点上，这个节点可以自己找到需要转发给那些节点，并且直接跟这些节点通信。所以从网络架构及服务配置上来说，构建集群所需要的配置及其简单。在ES2.0之前，无阻碍的网络下，所有配置了相同<code>cluster.name</code>的节点都自动归属到一个集群中。2.0版本之后，基于安全的考虑避免开发环境过于随便造成的麻烦，从2.0版本开始，默认的自动默认的发现方式改为了广播（unicast）方式。配置里提供几台节点的地址。ES将其视作gossip router角色，借以完成集群的发现。由于这只是ES内一个很小的功能，索引gossip router角色并不需要单独配置，每个ES节点都可以担任，索引采用广播方式的集群，各节点都配置相同的几个节点列表作为router即可。</li>
<li>集群中节点数量没有限制，一般大于等于2个节点就可以看做是集群了。一般处于高性能及高可用方面来考虑一般集群中的节点数量都是3个及3个以上。</li>
</ul>
<h3 id="集群概念"><a href="#集群概念" class="headerlink" title="集群概念"></a>集群概念</h3><ul>
<li><p>集群 cluster</p>
<p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。一个集群由一个唯一的名字标识，这个名字默认就是“elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群</p>
</li>
<li><p>节点 node</p>
<p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于Elasticsearch集群中的哪些节点。 一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此， 它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。 在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点， 这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。</p>
</li>
<li><p>分片和复制shards&amp;replicas</p>
<p>一个索引可以存储超出单个节点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。分片很重要，主要有两方面的原因：</p>
<ul>
<li>允许你水平分割/扩展你的内容容量。</li>
<li>允许你在分片（潜在地，位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说，这些都是透明的。在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为搜索可以在所有的复制上并行运行。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。默认情况下，Elasticsearch中的每个索引被分片5个主分片和1个复制，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共就有10个分片。</li>
</ul>
</li>
</ul>
<h3 id="集群原理"><a href="#集群原理" class="headerlink" title="集群原理"></a>集群原理</h3><ul>
<li><p>我们面临的第一个问题就是数据量太大，单点存储量有限的问题。大家觉得应该如何解决？我们可以把数据拆分成多份，每一份存储到不同机器节点（node），从而实现减少每个节点数据量的目的。这就是数据的分布式存储，也叫做：数据分片（Shard）。</p>
<p><img src="/2020/02/16/Elasticsearch/1573541795932.png" alt="1573541795932"> </p>
</li>
<li><p>数据分片解决了海量数据存储的问题，但是如果出现单点故障，那么分片数据就不再完整，这又该如何解决呢？就像大家为了备份手机数据，会额外存储一份到移动硬盘一样。我们可以给每个分片数据进行备份，存储到其它节点，防止数据丢失，这就是数据备份，也叫数据副本（replica）。</p>
</li>
<li><p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p>
</li>
<li><p>为了在高可用和成本间寻求平衡，我们可以这样做：首先对数据分片，存储到不同节点</p>
<p>然后对每个分片进行备份，放到对方节点，完成互相备份这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p><img src="/2020/02/16/Elasticsearch/1573541887624.png" alt="1573541887624"> </p>
<p>在这个集群中，如果出现单节点故障，并不会导致数据缺失，所以保证了集群的高可用，同时也减少了节点中数据存储量。并且因为是多个节点存储数据，因此用户请求也会分发到不同服务器，并发能力也得到了一定的提升。</p>
</li>
</ul>
<h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><ul>
<li><p>复制es节点三份，并且删除<code>data</code>目录</p>
</li>
<li><p>修改三个节点上的信息，内容如下:</p>
<ul>
<li><p>三个节点端口号: http端口号(9201、9202、9203)  tcp端口号(9301、9302、9303)</p>
</li>
<li><p>第一个节点配置(elasticsearch.yml)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群的名字，保证唯一，所有都必须一致 (17行)</span></span><br><span class="line"><span class="meta">cluster.name</span>: <span class="string">cluster-es</span></span><br><span class="line"><span class="comment"># 节点名称，必须不一样 (23行)</span></span><br><span class="line"><span class="meta">node.name</span>: <span class="string">node-1</span></span><br><span class="line"><span class="comment"># 必须为本机的ip地址 (55行)</span></span><br><span class="line"><span class="meta">network.host</span>: <span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># 服务器断开，在同一机器下必须不一样 (59行)</span></span><br><span class="line"><span class="meta">http.port</span>: <span class="string">9201</span></span><br><span class="line"><span class="comment"># 集群间通讯端口号，在同一机器下必须不一样 (60行)</span></span><br><span class="line"><span class="meta">transport.tcp.port</span>: <span class="string">9301</span></span><br><span class="line"><span class="comment"># 设置集群自动发现机器ip:port集合，采用广播模式 (70行)</span></span><br><span class="line"><span class="meta">discovery.zen.ping.unicast.hosts</span>: <span class="string">["127.0.0.1:9301","127.0.0.1:9302","127.0.0.1:9303"]</span></span><br><span class="line"><span class="comment"># 防止脑裂。声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1 (75行)</span></span><br><span class="line"><span class="meta">discovery.zen.minimum_master_nodes</span>: <span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域 (92、93行)</span></span><br><span class="line"><span class="meta">http.cors.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="meta">http.cors.allow-origin</span>: <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二个节点配置(elasticsearch.yml)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群的名字，保证唯一，所有都必须一致 (17行)</span></span><br><span class="line"><span class="meta">cluster.name</span>: <span class="string">cluster-es</span></span><br><span class="line"><span class="comment"># 节点名称，必须不一样 (23行  改)</span></span><br><span class="line"><span class="meta">node.name</span>: <span class="string">node-2</span></span><br><span class="line"><span class="comment"># 必须为本机的ip地址 (55行)</span></span><br><span class="line"><span class="meta">network.host</span>: <span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># 服务器断开，在同一机器下必须不一样 (59行 改)</span></span><br><span class="line"><span class="meta">http.port</span>: <span class="string">9202</span></span><br><span class="line"><span class="comment"># 集群间通讯端口号，在同一机器下必须不一样 (60行 改)</span></span><br><span class="line"><span class="meta">transport.tcp.port</span>: <span class="string">9302</span></span><br><span class="line"><span class="comment"># 设置集群自动发现机器ip:port集合，采用广播模式 (70行)</span></span><br><span class="line"><span class="meta">discovery.zen.ping.unicast.hosts</span>: <span class="string">["127.0.0.1:9301","127.0.0.1:9302","127.0.0.1:9303"]</span></span><br><span class="line"><span class="comment"># 防止脑裂。声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1 (75行)</span></span><br><span class="line"><span class="meta">discovery.zen.minimum_master_nodes</span>: <span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域 (92、93行)</span></span><br><span class="line"><span class="meta">http.cors.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="meta">http.cors.allow-origin</span>: <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三个节点配置(elasticsearch.yml)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群的名字，保证唯一，所有都必须一致 (17行)</span></span><br><span class="line"><span class="meta">cluster.name</span>: <span class="string">cluster-es</span></span><br><span class="line"><span class="comment"># 节点名称，必须不一样 (23行 改)</span></span><br><span class="line"><span class="meta">node.name</span>: <span class="string">node-3</span></span><br><span class="line"><span class="comment"># 必须为本机的ip地址 (55行)</span></span><br><span class="line"><span class="meta">network.host</span>: <span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># 服务器断开，在同一机器下必须不一样 (59行 改)</span></span><br><span class="line"><span class="meta">http.port</span>: <span class="string">9203</span></span><br><span class="line"><span class="comment"># 集群间通讯端口号，在同一机器下必须不一样 (60行 改)</span></span><br><span class="line"><span class="meta">transport.tcp.port</span>: <span class="string">9303</span></span><br><span class="line"><span class="comment"># 设置集群自动发现机器ip:port集合，采用广播模式 (70行)</span></span><br><span class="line"><span class="meta">discovery.zen.ping.unicast.hosts</span>: <span class="string">["127.0.0.1:9301","127.0.0.1:9302","127.0.0.1:9303"]</span></span><br><span class="line"><span class="comment"># 防止脑裂。声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1 (75行)</span></span><br><span class="line"><span class="meta">discovery.zen.minimum_master_nodes</span>: <span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域 (92、93行)</span></span><br><span class="line"><span class="meta">http.cors.enabled</span>: <span class="string">true</span></span><br><span class="line"><span class="meta">http.cors.allow-origin</span>: <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>分别启动三个es节点</p>
</li>
<li><p>通过es-header-master查看，连接任意一个节点都可以出现下面的效果，说明集群成功。</p>
<p><img src="/2020/02/16/Elasticsearch/1573534273127.png" alt="1573534273127">  </p>
</li>
</ul>
<h3 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h3><p><strong>编程步骤</strong></p>
<ul>
<li>创建Settings配置信息对象</li>
<li>创建ES传输客户端对象</li>
<li>使用传输客户端对象创建索引库</li>
<li>释放资源</li>
</ul>
<p><strong>核心代码</strong></p>
<ul>
<li><p>连接集群</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建Settings配置信息对象(主要配置集群名称)</span></span><br><span class="line"><span class="comment">// 参数一: 集群key (固定不变)</span></span><br><span class="line"><span class="comment">// 参数二：集群环境名称,默认的ES的环境集群名称为 "elasticsearch"</span></span><br><span class="line">Settings settings = Settings.builder()</span><br><span class="line">    .put(<span class="string">"cluster.name"</span>, <span class="string">"cluster-es"</span>).build();</span><br><span class="line"><span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line"><span class="comment">// 2.1 添加传输地址对象(集群环境多个)</span></span><br><span class="line"><span class="comment">// 参数一：主机</span></span><br><span class="line"><span class="comment">// 参数二：端口</span></span><br><span class="line">transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">        TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9301</span>));</span><br><span class="line">transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">        TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9302</span>));</span><br><span class="line">transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">        TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9303</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置分片与副本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 创建索引库(index)</span></span><br><span class="line"><span class="comment">// 获取创建索引库请求构建对象</span></span><br><span class="line">CreateIndexRequestBuilder cirb = transportClient.admin().indices()</span><br><span class="line">    .prepareCreate(<span class="string">"blog1"</span>);</span><br><span class="line"><span class="comment">// 3.1 创建Map集合封装分片与副本设置信息</span></span><br><span class="line">Map&lt;String, Integer&gt; source = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line"><span class="comment">// 3.2 设置分片数量</span></span><br><span class="line">source.put(<span class="string">"number_of_shards"</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 3.3 设置副本数量</span></span><br><span class="line">source.put(<span class="string">"number_of_replicas"</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 3.4 设置map集合，执行请求</span></span><br><span class="line">cirb.setSettings(source).get();</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/16/Elasticsearch/1573542875065.png" alt="1573542875065"> </p>
</li>
</ul>
<p><strong>完整代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.create.CreateIndexRequestBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequestBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentFactory;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 创建索引库(集群环境) */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 1. 创建Settings配置信息对象(主要配置集群名称)</span></span><br><span class="line">        <span class="comment">// 参数一: 集群key (固定不变)</span></span><br><span class="line">        <span class="comment">// 参数二：集群环境名称,默认的ES的环境集群名称为 "elasticsearch"</span></span><br><span class="line">        Settings settings = Settings.builder()</span><br><span class="line">                .put(<span class="string">"cluster.name"</span>, <span class="string">"cluster-es"</span>).build();</span><br><span class="line">        <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">        TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">        <span class="comment">// 2.1 添加传输地址对象(集群环境多个)</span></span><br><span class="line">        <span class="comment">// 参数一：主机</span></span><br><span class="line">        <span class="comment">// 参数二：端口</span></span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9301</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9302</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9303</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建索引库(index)</span></span><br><span class="line">        <span class="comment">// 获取创建索引库请求构建对象</span></span><br><span class="line">        CreateIndexRequestBuilder cirb = transportClient.admin().indices()</span><br><span class="line">                .prepareCreate(<span class="string">"blog1"</span>);</span><br><span class="line">        <span class="comment">// 3.1 创建Map集合封装分片与副本设置信息</span></span><br><span class="line">        Map&lt;String, Integer&gt; source = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">        <span class="comment">// 3.2 设置分片数量</span></span><br><span class="line">        source.put(<span class="string">"number_of_shards"</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 3.3 设置副本数量</span></span><br><span class="line">        source.put(<span class="string">"number_of_replicas"</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 3.4 设置map集合，执行请求</span></span><br><span class="line">        cirb.setSettings(source).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 释放资源</span></span><br><span class="line">        transportClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 添加文档 (集群环境) */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 1. 创建Settings配置信息对象(主要配置集群名称)</span></span><br><span class="line">        Settings settings = Settings.builder()</span><br><span class="line">                .put(<span class="string">"cluster.name"</span>, <span class="string">"cluster-es"</span>).build();</span><br><span class="line">        <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">        TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">        <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9301</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9302</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9303</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建内容构建对象</span></span><br><span class="line">        XContentBuilder builder = XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                .field(<span class="string">"id"</span>, <span class="number">1</span>)</span><br><span class="line">                .field(<span class="string">"title"</span>, <span class="string">"elasticsearch搜索服务"</span>)</span><br><span class="line">                .field(<span class="string">"content"</span>,<span class="string">"ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎。"</span>)</span><br><span class="line">                .endObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行索引库、类型、文档</span></span><br><span class="line">        transportClient.prepareIndex(<span class="string">"blog1"</span>,<span class="string">"article"</span>, <span class="string">"1"</span>)</span><br><span class="line">                .setSource(builder).get(); <span class="comment">// 执行请求</span></span><br><span class="line">        <span class="comment">// 5. 释放资源</span></span><br><span class="line">        transportClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 匹配全部 (集群环境) */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建Settings配置信息对象(主要配置集群名称)</span></span><br><span class="line">        Settings settings = Settings.builder()</span><br><span class="line">                .put(<span class="string">"cluster.name"</span>, <span class="string">"cluster-es"</span>).build();</span><br><span class="line">        <span class="comment">// 2. 创建ES传输客户端对象</span></span><br><span class="line">        TransportClient transportClient = <span class="keyword">new</span> PreBuiltTransportClient(settings);</span><br><span class="line">        <span class="comment">// 2.1 添加传输地址对象</span></span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9301</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9302</span>));</span><br><span class="line">        transportClient.addTransportAddress(<span class="keyword">new</span></span><br><span class="line">                TransportAddress(InetAddress.getByName(<span class="string">"127.0.0.1"</span>), <span class="number">9303</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建搜索请求构建对象</span></span><br><span class="line">        SearchRequestBuilder searchRequestBuilder = transportClient</span><br><span class="line">                .prepareSearch(<span class="string">"blog1"</span>).setTypes(<span class="string">"article"</span>);</span><br><span class="line">        <span class="comment">// 3.1 设置查询条件(匹配全部)</span></span><br><span class="line">        searchRequestBuilder.setQuery(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行请求，得到搜索响应对象</span></span><br><span class="line">        SearchResponse searchResponse = searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        System.out.println(<span class="string">"总命中数："</span> + hits.totalHits);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 迭代搜索结果</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">"JSON字符串："</span> + hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">"id: "</span> + hit.getSourceAsMap().get(<span class="string">"id"</span>));</span><br><span class="line">            System.out.println(<span class="string">"title: "</span> + hit.getSourceAsMap().get(<span class="string">"title"</span>));</span><br><span class="line">            System.out.println(<span class="string">"content: "</span> + hit.getSourceAsMap().get(<span class="string">"content"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 7. 释放资源</span></span><br><span class="line">        transportClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意: 修改cluster.name的集群名字保持和配置中的一致。</p>
<p><img src="/2020/02/16/Elasticsearch/1573542567904.png" alt="1573542567904"> </p>
<blockquote>
<p>说明: 测试关闭一个es节点，整个集群还是可以正常访问。</p>
</blockquote>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Zhong L</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E5%85%A5%E9%97%A8/"># 入门</a>
                    
                        <a href="/tags/ElasticSearch/"># ElasticSearch</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/01/05/%E4%BA%8C%E5%88%86%E6%B3%95%E5%85%A5%E9%97%A8/">二分查找法入门</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Zhong L | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
